# Architecture for Flow with Wardley Mapping, DDD, and Team Topologies

年の瀬ご多端の折、皆様におかれましては本年もお世話になりました。プロダクト開発部の塚本です。
本記事はクラウドワークスアドベントカレンダー24日目の記事です。

我々の組織ではこれまでも技術的負債解消に取り組んできていましたが、今期（10月）よりさらに人と時間をそこに集中しています。これまでこのブログでも紹介されてきたようにRuby on Railsのモノリスとなっているcrowdworks.jpですが、フロントエンドのVue.jsへの移行は着々と進む中、バックエンドのほうは保守性の低下からどう脱却していくかが手付かずに近い状態でした。

まだ道半ばではありますが、その対応方針を決めていっている中でのこれまでの道程をまとめておきます。
（ここからは冗長さを除くため、である調になります）

## 課題
Railsバックエンドに関しては、過去にもリファクタリングに挑んだことがあり、そのときどきのレイヤーが残って地層となっている状態だった。かつ残っているドキュメントと現在の構造を頭の中で整合させながら読むという、新たにジョインしたエンジニアにとっては非常に難読な課題が一つ（私もその一人）。

また新たに機能追加するにおいても、どの地層に合わせた構造にするべきなのかが決まっておらず、最終的に個々の判断に委ねられるため、さらに統一性が失われるという課題もあった。

現場で見られる、より詳細な事象に目を向けると
- コミュニケーションの中で使われる用語の解釈の調整があちこちで起きている（ユビキタス言語がない）
- コード上のコンテキストが実装技術に依拠した分かれ方をしている（実装上のコンテキストがビジネスの実態と一致していない）

これらの課題を見る限り、複雑化したドメイン、すなわちユーザの活動や状態のモデルをうまく扱う必要がある。となるとまず最初にドメイン駆動設計（以下DDD）が浮かび上がってくるが、現状はメンバーのDDDに対する理解やバックグラウンドにバラツキがあり、またDDDを採用すれば解決する問題のようにもあまり思えなかった。

その大きな理由としては、過去にも同様のチャレンジがあった中、結果的に頓挫となっている要因が、設計や開発プロセスよりも手前にありそうという仮説があったためである。他にもRuby on RailsとDDDの戦術的設計の相性が悪いという問題もあるが、これは根本的理由ではないと位置づけた。

## 負債を生む構造の問題
基本的には、技術的負債を借りたくて借りているエンジニアはそういないはずである。いかに市場に価値を早く提供したくとも、借り入れをせずに済むならそのほうがよい。借り入れせざるを得ない何らかの要因があるわけで、ビジネス的な速度の要求**以外**でよくある話としては「個別の機能の局所最適化が全体戦略との接合点を欠いている」といった文脈である。

機能開発に限らず、ユーザーのニーズに素早く対応するために既製品を組み込んだりすること自体は間違った意思決定ではない。しかし「そのコンポーネントがバリューチェーンのどこに位置しているのか」といった、価値の変化を継続的に観察していないことは言い訳にしてはいけない。

このような例は、一定以上ユーザーに使ってもらえるようになったプロダクトにおいては珍しい話ではないが、これに対して、「では全体戦略を決めましょう」という対策だけでは逆に何も変わらないという個人的経験もあった。

つまり全体戦略だけではない現場感に即した設計が必要なのだけど、そういったトップダウンとボトムアップ双方からのアプローチとなるフレームワークみたいなものが無いか今年の頭くらいから時間を見つけては調べていた。

## Architecture for Flow with Wardley Mapping, DDD, and Team Topologies
そのような状況の中でたまたま今年5月のInfoQの[QCon Plus May 2022](https://plus.qconferences.com/recap/may2022)でSusanne Kaiser氏による[Architecture for Flow with Wardley Mapping, DDD, and Team Topologies
](https://www.infoq.com/presentations/ddd-wardley-mapping-team-topology/)というセッションを視聴し、これがよかったので紹介していく。

簡単に言うと、 *Wardley Mapping、DDD、およびチームトポロジーは、それぞれ異なる分野で用いられるものだが、それらを組み合わせることで、より良いプロダクトを構築するための強力なツールセットになる*という内容。個別に少しずつ紹介していく。

### Wardley Mapping
英国の研究者Simon Wardleyによって考案された戦略フレームワークで、状況認識と戦略サイクルに沿った動きに基づいてビジネス戦略を設計し、プロダクトを進化させるのに役立つもの。

自分も名前だけは聞いたことあるレベルだったが、このセッションのあと[公式サイト](https://learnwardleymapping.com/)や[以前のInfoQのセッション](https://www.infoq.com/presentations/interview-wardley-maps/?itm_source=presentations_about_wardley-mapping&itm_medium=link&itm_campaign=wardley-mapping)を観た。

バリューストリームを縦軸、製品開発のステージを横軸としたマップとなっていて、自分たちの製品やどこに位置していて、市場環境から見てどうなっているかを俯瞰して見れるようになる。

### DDD（ドメイン駆動設計）
ソフトウェアエンジニアには比較的馴染みがあると思うのでここでは省略

### Team Topologies
時間とともに変化していくコンテキストに対応するために技術戦略と組織戦略を結びつける実践的なアプローチ。
概略は昨年書いたこちら[Team Topologies(by Manuel Pais)のキーポイント](https://zenn.dev/hihats/articles/mp_on_team_topologies)をどうぞ。

## これらを組み合わせると何が嬉しいのか
### Wardley MappingとDDD
まずはDDD（というかEvans本出版時）の時代背景として、エンタープライズアプリケーションの開発者が主流な時勢であったことを頭に入れておく必要がある。crowdworks.jpのようにLarge set of unknown usersに使用されるWebアプリケーションのことは想定して書かれていなかった。つまり現在のソフトウェア開発者は2003年当時より不確実性が高く、ユーザーのことを知らない状況でのプロダクトづくりをしているということである。

Wardley Mappingではまず「なぜ作るのか」の再確認から入り、自分たちが置かれた複雑な地形（Landscape）を理解し、原則（Doctrin）として「ユーザーを知る」ことがある。その後にDomain Driven Designの出番が来るとKaiser氏は（たぶん）言っていた。Evans本でも「ユーザーのためにドメインに没頭せよ」とは言っているが、その前段としてまず「ユーザーを知る」ことは強調されていないと解釈している。（最近のDDD Europeあたりでは言われてた気がするがそこにアクセスする人は多くない）

要するに、現在の我々の開発においては必要なステップが足りていない。上記`課題`の箇所で「DDDだけでは不十分では」と感じた背景と自分の中ではつながった。

次に既製品の導入にどう対処していくかの課題について（これも上記課題に記載）。Evans本ではGenericサブドメインとして、既製品を導入するか、自社で実装するかなどいくつか選択肢を提示してくれているが、現在はSaaSやクラウドのマネージドサービスのように既製品の安定化や進化のスピードが当時とは桁違いで、そこの想定が足りていない。

Wardley Mappingでは、各コンポーネントがバリューチェーン（縦軸上）でどうなっているかを確認できることにより、それらをアジャイルにカスタムビルドするか、リーンで対応するかの選択肢が逐次迫られる。

一言で言ってしまえばBizDevOpsっぽい話ではあるが、フレームワーク的に組み込まれることが嬉しい。

### Team TopologiesとDDD
チームトポロジーとは大胆に言い切ってしまうと **チームの認知負荷とコンウェイの法則**の話である。ただこのいかにもシンプルなポイントもDDDで足りない部分を補ってくれる。

どういうことかを説明する前にDDDの基本からおさらいすると、Eric EvansはDDDを駆動している原則は基本的に3つだけとしている。

- コアドメインに集中すること
- ドメインの実践者とソフトウェアの実践者による創造的な共同作業を通じて、モデルを探求すること
- 明示的な境界づけられたコンテキストの内部で、ユビキタス言語を語ること

例えばユーザーが特定の固定客である業務アプリケーションであれば、ドメインモデル ↔ コードの往復は多くてもせいぜい顧客との定例Mtgと同頻度だった。先述のように、Volatilityの高い現代においては変化に対応するために**日常的&&継続的に**行っていく必要性が高くなる。日常的に行われるとなるとおそらく多くの人がコミュニケーションの労力が高いと感じる。

だがそれはモデルを成熟させるために必要なコミュニケーションであるので、忌避感を取り除く仕組みが必要である。イコール「認知負荷の問題にどう対処するか」であり、チームトポロジーはそれにどう立ち向かっていくかの話である。（詳しくはこちら[Team Topologies(by Manuel Pais)のキーポイント](https://zenn.dev/hihats/articles/mp_on_team_topologies)）

また、動作中のシステムからのフィードバックをチームが受けることができるよう最適化するアプローチでもあるので、DDDのイテレーティブな設計を支援することもできる。


## システム構築の挑戦
一般的にシステムを構築する場合、私たちは「正しいものを作る」ことと「正しくものを作る」ことの間の問題に直面することになります。正しいものを作るということは、効果的なものを作るということであり、次のような問いに取り組むことです：「我々のソリューションはユーザーのニーズにどれだけ合致しているか？顧客のために価値を創造しているか？私たちは問題を理解し、共通の認識を持つことができたか？一方、"Building the thing right "は、効率性、例えばエンジニアリングの効率性に焦点を当てます。価値を生み出すだけでなく、その価値を提供できること、そして、いかに早く変化を提供できるか、いかに早く簡単に変化を有効にし、新しい状況に適応できるか、が重要です。しかし、ラッセル・アッコフ博士が指摘したように、間違ったことを正しく行うことは、正しいことを間違って行うことほど良いことはないのです。

## 適応システムを構築する3つの視点
全体を考え、有効性と効率性を念頭に置き、正しいものを正しく構築するためには、適応システムを構築するための全体的な視点が必要なのです。今回ご紹介するのは、ビジネス戦略とワードリーマッピング、ソフトウェア設計とアーキテクチャとドメイン駆動設計、そしてチーム編成とチームトポロジーの視点を組み合わせることで、変化の速いフローに最適化された適応型社会技術システムを設計、構築、進化させるというアプローチです。

## Legacyシステムを進化させる
この3つの視点を、レガシーシステムを進化させることでまとめてみましょう。ここでは、機能別サイロチームによって構築、運営、サポートされているレガシーシステムをベースにした、**ジュニア向けのオンラインスクール** を架空の例として使用します。まず、あるチームから、チームの認知負荷やデリバリーボトルネックなどの現状分析を行い、システムを進化させます。また、機能別サイロチームでは、ハンドオーバーのため、変更の実装やリリース時にチーム間のコミュニケーションや調整に多大な労力を要することが報告されています。雑然としたモデルで明確な境界のないモノリシックな大きな泥の塊を扱うことは，高い認知負荷と厳しい変更の結合につながる．コードの一部を理解するのに多大な労力を要するのです。さらに、所有権の境界が明確でないため、一般的にデリバリーのボトルネックとなり、ソフトウェアデリバリーのパフォーマンスに支障をきたすことが報告されています。オンプレミスのインフラストラクチャのため、運用活動は、設定、バックアップとリカバリの仕組み、アップグレードやセキュリティアップデートなどのメンテナンス、スケーリング、モニタリングなどで構成されています。インフラチームは、非常に高い運用努力に直面していました。システム思考からの注意点として、部分的に最適化を図ったとしても、全体のパフォーマンスを向上させることはできません。





ドメイン駆動設計 (DDD) は、ソフトウェア開発のアプローチのひとつで、ビジネスドメインにおける概念やプロセスを明確にし、それらを設計や実装に反映させることを目的としています。DDDでは、ドメインモデルを中心にしたアプローチをとり、ビジネスにおける概念やプロセスを設計に反映することで、より良いシステムを構築することを目的としています。

チームトポロジーは、チームを構成する人々の関係性や、その人々が取り組むタスクや業務をどのように分配するかを決める考え方のことを指します。チームトポロジーは、チームが効率的に仕事を進めるために、人々の関係性やタスクの分配を考慮したアプローチが求められる場合に用いられることがあります。

Wardley map、DDD、およびチームトポロジーは、それぞれ異なる分野で用いられるものですが、それらを組み合わせることで、より良いプロダクトやサービスを構築するた

ます。たとえば、Wardley mapを用いてプロダクトやサービスの戦略的な考え方を策定したあと、DDDを用いてそのプロダクトやサービスを設計するときには、その設計に基づいて、チームトポロジーを考慮してタスクを分配することができます。また、チームトポロジーを考慮してタスクを分配した結果、DDDを用いて設計されたプロダクトやサービスをより効率的に構築することもできます。

一方で、Wardley mapやDDD、チームトポロジーを個別に用いることもできます。Wardley mapは、プロダクトやサービスの戦略的な考え方を策定するために用いられることが多いですが、DDDやチームトポロジーと組み合わせることで、より具体的な設計や実装につなげることもできます。DDDは、ビジネスにおける概念やプロセスを設計に反映することで、より良いシステムを構築することを目的としていますが、Wardley mapやチームトポロジーと組み合わせることで、より戦略的な考え方や、タスクの分配を考慮した実装につなげることもできます。

また、チームトポロジーは、チームを構成する人々の関係性や、その人々が取り組むタスクや業務をどのように分配するかを決めるために用いられることがありますが、Wardley mapやDDDと組み合わせることで、より具体的なプロダクトやサービスを構築するための戦略的な考え方や設計を考慮することもできます。

つまり、Wardley map、DDD、およびチームトポロジーは、それぞれ異なる分野で用いられるものですが、組み合わせることでより良いプロダクトやサービスを構築するための戦略的な考え方や設計、タスクの分配を考慮することができます。これらのツールやアプローチを適切に組み合わせることで、より効率的でスムーズなプロダクトやサービスの開発や運用ができるようになります。

ただし、Wardley mapやDDD、チームトポロジーを使うことで、必ずしもプロダクトやサービスの開発や運用がうまくいくとは限りません。そのため、それらを用いる際には、それらがどのように組み合わせられるか、その組み合わせがどのようにプロダクトやサービスを構築する上で有益であるかを慎重に検討することが重要です。
